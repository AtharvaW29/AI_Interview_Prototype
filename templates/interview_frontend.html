<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Assistant</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.js"></script>

    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: var(--dark-color);
            min-height: 100vh;
            padding-bottom: 3rem;
            position: relative;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .app-container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            position: relative;
            margin-top: -50px;
        }

        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            background-color: rgba(67, 97, 238, 0.05);
            border-bottom: none;
            font-weight: 600;
            padding: 1rem 1.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(67, 97, 238, 0.3);
        }

        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 8px;
            font-weight: 500;
        }

        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .form-control, .form-select {
            border-radius: 8px;
            padding: 0.6rem 1rem;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
        }

        label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: block;
        }

        .progress-indicator {
            margin-bottom: 2rem;
        }

        .question-container {
            background-color: rgba(67, 97, 238, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }

        .status-badge {
            display: inline-block;
            padding: 0.35rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-connected {
            background-color: rgba(76, 201, 240, 0.15);
            color: var(--accent-color);
        }

        .status-waiting {
            background-color: rgba(255, 152, 0, 0.15);
            color: var(--warning-color);
        }

        .status-complete {
            background-color: rgba(76, 175, 80, 0.15);
            color: var(--success-color);
        }

        .status-error {
            background-color: rgba(244, 67, 54, 0.15);
            color: var(--danger-color);
        }

        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: var(--danger-color);
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(244, 67, 54, 0);
            }
        }

        .results-container {
            background-color: rgba(76, 175, 80, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(76, 175, 80, 0.2);
        }

        .results-container pre {
            background-color: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
            width: 0;
        }

        .custom-file-input::before {
            content: 'Browse';
            display: inline-block;
            background: var(--light-color);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            font-weight: 500;
            margin-left: 10px;
        }

        .custom-file-input:hover::before {
            border-color: var(--primary-color);
        }

        .file-input-container {
            position: relative;
        }

        .file-name {
            position: absolute;
            left: 110px;
            top: 50%;
            transform: translateY(-50%);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .big-recording-button {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            margin: 0 auto;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .big-recording-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .big-recording-button.recording {
            background-color: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        .recording-time {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1rem;
            text-align: center;
        }

        .audio-visualizer {
            width: 100%;
            height: 60px;
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            margin: 1rem 0;
            position: relative;
            overflow: hidden;
        }

        .visualizer-bars {
            display: flex;
            height: 100%;
            justify-content: space-between;
            align-items: flex-end;
            padding: 0 10px;
        }

        .visualizer-bar {
            width: 5px;
            background-color: var(--primary-color);
            border-radius: 2px;
            margin: 0 2px;
        }

        .recording-instructions {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .interview-tips {
            background-color: rgba(67, 97, 238, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .interview-tips h5 {
            color: var(--primary-color);
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .interview-tips ul {
            padding-left: 1.5rem;
            margin-bottom: 0;
        }

        .transcription-box {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid #e0e0e0;
            min-height: 100px;
        }

        .transcription-title {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="app-header text-center">
        <h1 class="mb-0"><i class="fas fa-comments me-2"></i>AI Interview Assistant</h1>
        <p class="lead mt-2">Practice your interview skills with AI-powered feedback</p>
    </div>

    <div class="container app-container">
        <div id="setup">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-play-circle me-2"></i>Start Your Interview</h2>
                <span class="badge bg-light text-dark">Step 1/2</span>
            </div>

            <form id="start-form" class="needs-validation" novalidate>
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-briefcase me-2"></i>Interview Details
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="embassy_or_consulate" class="form-label">Embassy or Consulate:</label>
                            <input type="text" id="embassy_or_consulate" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="destination_country" class="form-label">Destination Country:</label>
                            <input type="text" id="destination_country" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="course" class="form-label">Course:</label>
                            <input type="text" id="course" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="university" class="form-label">University:</label>
                            <input type="text" id="university" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="num_questions" class="form-label">Number of Questions:</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-list-ol"></i></span>
                                <input type="number" id="num_questions" class="form-control" value="3" min="1" max="10" required>
                            </div>
                            <div class="form-text">Choose between 1-10 questions for your interview session.</div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="fas fa-file-alt me-2"></i>Resume Upload
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="resume_file" class="form-label">Your Resume (JSON Format):</label>
                            <div class="file-input-container">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-upload"></i></span>
                                    <input type="file" id="resume_file" class="form-control custom-file-input" accept=".json" required>
                                </div>
                                <div id="file-name" class="file-name"></div>
                            </div>
                            <div class="form-text">Upload your resume in JSON format to tailor questions to your experience.</div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-rocket me-2"></i>Start Interview
                    </button>
                </div>
            </form>
        </div>

        <div id="interview" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0"><i class="fas fa-comments me-2"></i>Interview Session</h2>
                <span class="badge bg-light text-dark">Step 2/2</span>
            </div>

            <div class="progress-indicator mb-4">
                <div class="progress" style="height: 8px;">
                    <div id="progress-bar" class="progress-bar bg-primary" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span class="small">Question <span id="question-number">1</span>/<span id="total-questions">3</span></span>
                    <span id="interview-progress-text" class="small text-muted">In progress</span>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-question-circle me-2"></i>Current Question
                    </div>
                </div>
                <div class="card-body">
                    <div class="question-container">
                        <p id="current-question" class="fs-5">Waiting for your first question...</p>
                    </div>

                    <div class="interview-tips">
                        <h5><i class="fas fa-lightbulb me-2"></i>Interview Tip:</h5>
                        <p id="interview-tip" class="mb-0 small">Remember to speak clearly and confidently. Pause to collect your thoughts before answering.</p>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-microphone me-2"></i>Record Your Answer
                </div>
                <div class="card-body">
                    <div id="answer-container" class="text-center">
                        <p class="recording-instructions">Click the microphone button to start recording your answer. Click again to stop.</p>

                        <div class="audio-visualizer">
                            <div id="visualizer-container" class="visualizer-bars">
                                <!-- Visualizer bars will be added dynamically -->
                            </div>
                        </div>

                        <div class="big-recording-button" id="toggle-recording">
                            <i class="fas fa-microphone"></i>
                        </div>

                        <div class="recording-time" id="recording-time">00:00</div>

                        <div class="mb-3 mt-4">
                            <div class="form-check form-switch d-flex justify-content-center">
                                <input class="form-check-input me-2" type="checkbox" id="generate-followup" checked>
                                <label class="form-check-label" for="generate-followup">Generate follow-up question</label>
                            </div>
                        </div>

                        <div id="transcription-container" class="mt-4" style="display:none;">
                            <div class="transcription-title">Your Transcribed Answer:</div>
                            <div class="transcription-box" id="transcription-text">
                                <!-- Transcribed text will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-info-circle me-2"></i>Interview Status
                </div>
                <div class="card-body">
                    <div id="status-container">
                        <p>
                            <strong>Status:</strong>
                            <span id="status-badge" class="status-badge status-waiting">
                                <i class="fas fa-circle-notch fa-spin me-2"></i>
                                <span id="status-text">Waiting to connect...</span>
                            </span>
                        </p>
                    </div>
                </div>
            </div>

            <div id="results" class="results-container" style="display:none;">
                <h3 class="mb-3"><i class="fas fa-chart-bar me-2"></i>Interview Analysis</h3>
                <pre id="analysis-results" class="language-json"></pre>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global Variables
        let socket;
        let sessionId;
        let mediaRecorder;
        let audioContext;
        let audioStream;
        let audioChunks = [];
        let currentQuestionNumber = 0;
        let totalQuestions = 0;
        let recordingStartTime;
        let recordingTimer;
        let analyser;
        let dataArray;
        let visualizerBars = [];
        let isRecording = false;

        // Interview tips to cycle through
        const interviewTips = [
            "Take a moment to structure your thoughts before answering.",
            "Use the STAR method: Situation, Task, Action, Result when describing experiences.",
            "Speak clearly and at a moderate pace to ensure your points are understood.",
            "Highlight relevant skills and experiences that match the job description.",
            "Be specific with examples rather than giving generic answers.",
            "It's okay to pause briefly to gather your thoughts during complex questions.",
            "Maintain a positive tone even when discussing challenges or conflicts.",
            "Quantify your achievements whenever possible with numbers or percentages.",
            "Keep your answers focused and relevant to the question asked.",
            "Show enthusiasm for the role and company in your responses."
        ];

        // Function to log for debugging
        function debugLog(message, data = null) {
            console.log(`[]DEBUG] ${message}`, data ? data : '');
        }

        // Function to update interview tip randomly
        function updateInterviewTip() {
            const tipIndex = Math.floor(Math.random() * interviewTips.length);
            document.getElementById('interview-tip').textContent = interviewTips[tipIndex];
        }

        // Update tip when starting and after each question
        function cycleTip() {
            updateInterviewTip();
            setTimeout(updateInterviewTip, 15000); // Change tip every 15 seconds
        }

        // File input enhancement
        document.getElementById('resume_file').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('file-name').textContent = this.files[0].name;
            } else {
                document.getElementById('file-name').textContent = '';
            }
        });

        // Setup audio visualizer
        function setupAudioVisualizer() {
            const visualizerContainer = document.getElementById('visualizer-container');
            
            // Clear existing bars
            visualizerContainer.innerHTML = '';
            visualizerBars = [];

            // Create visualizer bars
            const barCount = 30;
            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                bar.style.height = '2px';
                visualizerContainer.appendChild(bar);
                visualizerBars.push(bar);
            }
        }

        // Initialize audio context and analyzer
        function initializeAudioContext(stream) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            source.connect(analyser);

            dataArray = new Uint8Array(analyser.frequencyBinCount);

            // Start visualization
            updateVisualization();
        }

        // Update visualization in animation frame
        function updateVisualization() {
            if (!isRecording || !analyser) return;

            requestAnimationFrame(updateVisualization);

            analyser.getByteFrequencyData(dataArray);

            // Update visualizer bars with audio data
            for (let i = 0; i < visualizerBars.length; i++) {
                const index = Math.floor(i * dataArray.length / visualizerBars.length);
                const value = dataArray[index] / 255.0;
                const height = Math.max(2, value * 60);
                
                if (visualizerBars[i]) {
                    visualizerBars[i].style.height = height + 'px';
                }
            }
        }

        // Format recording time as MM:SS
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Update recording timer display
        function updateRecordingTime() {
            if (!recordingStartTime) return;

            const elapsed = Date.now() - recordingStartTime;
            document.getElementById('recording-time').textContent = formatTime(elapsed);
        }

        // Toggle recording function
        async function toggleRecording() {
            console.log('Toggle recording called, current state:', isRecording);
            
            if (!isRecording) {
                try {
                    // Start recording
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    audioStream = stream;
                    audioChunks = [];

                    mediaRecorder = new MediaRecorder(stream);

                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };

                    mediaRecorder.onstop = async () => {
                        console.log('MediaRecorder stopped, processing audio...');
                        if (audioChunks.length === 0) {
                            console.warn('No audio data recorded');
                            updateStatus('No audio recorded, please try again', 'error');
                            resetRecordingState();
                            return;
                        }

                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = function() {
                            const base64Audio = reader.result.split(',')[1];
                            const generateFollowUp = document.getElementById('generate-followup').checked;

                            console.log('Sending audio data for session:', sessionId);

                            // Send the audio data to the server
                            socket.emit('submit_answer', {
                                session_id: sessionId,
                                audio: base64Audio,
                                generateFollowUp: generateFollowUp
                            });

                            updateStatus('Processing your answer...', 'waiting');

                            // Show transcription container
                            document.getElementById('transcription-container').style.display = 'block';
                            document.getElementById('transcription-text').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing your answer...';
                        };

                        // Clean up audio stream
                        if (audioStream) {
                            audioStream.getTracks().forEach(track => track.stop());
                            audioStream = null;
                        }
                    };

                    mediaRecorder.onerror = (event) => {
                        console.error('MediaRecorder error:', event.error);
                        updateStatus('Recording error occurred', 'error');
                        resetRecordingState();
                    };

                    // Start recording
                    mediaRecorder.start(1000);
                    initializeAudioContext(stream);
                    isRecording = true;
                    
                    // Update UI
                    document.getElementById('toggle-recording').classList.add('recording');
                    document.getElementById('toggle-recording').innerHTML = '<i class="fas fa-stop"></i>';

                    // Start timer
                    recordingStartTime = Date.now();
                    recordingTimer = setInterval(updateRecordingTime, 1000);

                    updateStatus('Recording your answer...', 'waiting');
                    console.log('Recording started successfully');

                } catch (error) {
                    console.error('Error starting recording:', error);
                    updateStatus(`Error recording audio: ${error.message}`, 'error');
                    alert(`Error recording audio: ${error.message}`);
                    resetRecordingState();
                }
            } else {
                // Stop recording
                console.log('Stopping recording...');
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }

                // Stop timer
                clearInterval(recordingTimer);

                // Update UI to show processing state
                document.getElementById('toggle-recording').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                document.getElementById('toggle-recording').classList.remove('recording');
                
                // Note: Don't reset isRecording here - let the onstop handler manage the state
                updateStatus('Processing your answer...', 'waiting');
            }
        }

        // Add event listener to recording button
        document.getElementById('toggle-recording').addEventListener('click', toggleRecording);

        // Start form submission
        document.getElementById('start-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const embassy_or_consulate = document.getElementById('embassy_or_consulate').value;
            const destination_country = document.getElementById('destination_country').value;
            const course = document.getElementById('course').value;
            const university = document.getElementById('university').value;
            const num_questions = document.getElementById('num_questions').value;
            const resumeFile = document.getElementById('resume_file').files[0];

            if (!embassy_or_consulate || !destination_country || !course || !university || !resumeFile) {
                alert('Please fill in all required fields');
                return;
            }

            // Show loading indicator
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            submitBtn.disabled = true;

            try {
                // Create form data
                const formData = new FormData();
                formData.append('embassy_or_consulate', embassy_or_consulate);
                formData.append('destination_country', destination_country);
                formData.append('course', course);
                formData.append('university', university);
                formData.append('num_questions', num_questions);
                formData.append('resume_file', resumeFile);

                // Make sure the API endpoint is correct
                const response = await fetch('http://localhost:5000/api/start-interview', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }

                const data = await response.json();

                if (data.mtype === 'success') {
                    sessionId = data.session_id;
                    debugLog('Session started with ID:', sessionId);
                    // Hide setup and show interview
                    document.getElementById('setup').style.display = 'none';
                    document.getElementById('interview').style.display = 'block';

                    // Initialize the interview environment
                    totalQuestions = parseInt(num_questions);
                    document.getElementById('total-questions').textContent = totalQuestions;
                    setupAudioVisualizer();
                    updateStatus('Connecting to interview session...', 'waiting');
                    cycleTip();

                    // Connect to WebSocket
                    connectWebSocket(sessionId);
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }
            } catch (error) {
                console.error("Error submitting form:", error);
                alert(`Error: ${error.message}`);
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Update status display
        function updateStatus(message, statusClass) {
            const statusElement = document.getElementById('status-text');
            const statusBadge = document.getElementById('status-badge');

            if (statusElement && statusBadge) {
                statusElement.textContent = message;

                // Remove all status classes
                statusBadge.classList.remove('status-waiting', 'status-connected', 'status-complete', 'status-error');

                // Add the appropriate class
                if (statusClass) {
                    statusBadge.classList.add(`status-${statusClass}`);

                    // Update icon based on status
                    let iconHTML = '';
                    switch(statusClass) {
                        case 'connected':
                            iconHTML = '<i class="fas fa-check-circle me-2"></i>';
                            break;
                        case 'waiting':
                            iconHTML = '<i class="fas fa-circle-notch fa-spin me-2"></i>';
                            break;
                        case 'complete':
                            iconHTML = '<i class="fas fa-flag-checkered me-2"></i>';
                            break;
                    case 'error':
                        iconHTML = '<i class="fas fa-exclamation-circle me-2"></i>';
                        break;
                    default:
                        iconHTML = '<i class="fas fa-info-circle me-2"></i>';
                }

                // Update the status badge HTML
                statusBadge.innerHTML = `${iconHTML}<span id="status-text">${message}</span>`;
            }
        }
    }

    // Update progress bar
    function updateProgressBar() {
        if (!currentQuestionNumber || !totalQuestions) return;

        const progressPercentage = (currentQuestionNumber / totalQuestions) * 100;
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.setAttribute('aria-valuenow', progressPercentage);
        }

        // Update progress text
        const progressText = document.getElementById('interview-progress-text');
        if (progressText) {
            if (progressPercentage >= 100) {
                progressText.textContent = 'Complete';
            } else {
                progressText.textContent = `${Math.round(progressPercentage)}% complete`;
            }
        }
    }

    function resetRecordingState() {
        // Stop any ongoing recording
        if (isRecording) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                try {
                    mediaRecorder.stop();
                } catch (e) {
                    console.warn('Error stopping recorder:', e);
                }
            }
            // Stop timer
            clearInterval(recordingTimer);
            // Stop audio stream
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
        }
        
        // Reset state variables
        isRecording = false;
        audioChunks = [];
        recordingStartTime = null;
        
        // Reset UI elements
        const recordButton = document.getElementById('toggle-recording');
        recordButton.classList.remove('recording');
        recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
        
        // Reset recording time display
        document.getElementById('recording-time').textContent = '00:00';
        
        // Hide previous transcription
        document.getElementById('transcription-container').style.display = 'none';
        document.getElementById('transcription-text').innerHTML = '';
        
        console.log('Recording state reset for new question');
    }

    // Connect to WebSocket server
    function connectWebSocket(sessionId) {
        // Close any existing connection
        if (socket) {
            socket.close();
        }

        // Connect to socket.io server
        socket = io('http://localhost:5000', {
            reconnectionAttempts: 5,
            timeout: 10000,
            transports: ['websocket', 'polling']
        });

        // Connection events
        socket.on('connect', () => {
            debugLog('Connected to server with ID:', socket.id);
            updateStatus('Connected to server, joining session...', 'connected');
            
            // Join the session after connection is established
            socket.emit('join_session', { session_id: sessionId });
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            updateStatus(`Connection error: ${error.message}`, 'error');
        });

        socket.on('disconnect', (reason) => {
            console.log('Disconnected:', reason);
            updateStatus(`Disconnected: ${reason}`, 'error');
        });

        // Session events
        socket.on('joined_session', (data) => {
            console.log('Joined session:', data.session_id);
            updateStatus('Session joined, waiting for first question...', 'connected');
        });

        socket.on('interview_status', (data) => {
            let statusMessage = data.status;
            let statusClass = 'waiting';
            
            switch(data.status) {
                case 'generating_questions':
                    statusMessage = 'Generating interview questions...';
                    break;
                case 'analyzing_responses':
                    statusMessage = 'Analyzing your responses...';
                    break;
                default:
                    statusMessage = data.status;
            }
            
            updateStatus(statusMessage, statusClass);
        });

        socket.on('new_question', (data) => {
            console.log("Received new question:", data);
            
            // Update question display
            document.getElementById('current-question').textContent = data.question;
            document.getElementById('question-number').textContent = data.question_number;
            
            // Update total questions if it changed (due to follow-ups)
            if (data.total_questions) {
                totalQuestions = data.total_questions;
                document.getElementById('total-questions').textContent = totalQuestions;
            }
            
            currentQuestionNumber = parseInt(data.question_number);
            updateProgressBar();

            resetRecordingState();

            // // IMPORTANT: Reset recording state for new question
            // if (isRecording) {
            //     // Stop any ongoing recording
            //     if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            //         mediaRecorder.stop();
            //     }
            //     // Stop timer
            //     clearInterval(recordingTimer);
            //     // Reset UI
            //     isRecording = false;
            //     document.getElementById('toggle-recording').classList.remove('recording');
            // }
            // Reset recording display
            document.getElementById('recording-time').textContent = '00:00';
            document.getElementById('toggle-recording').innerHTML = '<i class="fas fa-microphone"></i>';
            
            // Hide previous transcription
            document.getElementById('transcription-container').style.display = 'none';
            document.getElementById('transcription-text').innerHTML = '';

            // Update status
            updateStatus(`Question ${data.question_number}/${totalQuestions} - Ready to record`, 'connected');

            // Update interview tip
            updateInterviewTip();

            // Scroll to the question
            document.getElementById('current-question').scrollIntoView({ behavior: 'smooth' });
        });

        socket.on('transcription_result', (data) => {
            console.log('Received transcription:', data);
            
            // Display transcription result
            document.getElementById('transcription-container').style.display = 'block';
            document.getElementById('transcription-text').innerHTML = data.transcription || 'No transcription available';
            
            updateStatus('Transcription received, waiting for next question...', 'connected');
        });

        socket.on('answer_received', (data) => {
            console.log('Answer received confirmation:', data);
            
            // Show transcription if available
            if (data.transcription) {
                document.getElementById('transcription-container').style.display = 'block';
                document.getElementById('transcription-text').innerHTML = data.transcription;
            }
            
            // Update progress
            currentQuestionNumber = parseInt(data.current_question_number);
            updateProgressBar();
            
            // Check if this was the last question
            if (currentQuestionNumber >= data.qlength) {
                updateStatus('Interview Complete - Processing final analysis...', 'complete');
            } else {
                updateStatus(`Answer ${currentQuestionNumber} processed - Waiting for next question...`, 'connected');
            }
            
            // Reset recording button state
            // document.getElementById('toggle-recording').innerHTML = '<i class="fas fa-microphone"></i>';
            // document.getElementById('toggle-recording').classList.remove('recording');
            // isRecording = false;
        });

        socket.on('interview_complete', (data) => {
            updateStatus('Interview Complete', 'complete');
            document.getElementById('results').style.display = 'block';
            document.getElementById('analysis-results').textContent = JSON.stringify(data.analysis, null, 2);

            // Update progress to 100%
            currentQuestionNumber = totalQuestions;
            updateProgressBar();

            // Scroll to results
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        });

        socket.on('transcription_error', (data) => {
            console.error('Transcription error:', data);
            document.getElementById('transcription-container').style.display = 'block';
            document.getElementById('transcription-text').innerHTML = `<span class="text-danger">Error processing audio: ${data.error}</span>`;
            updateStatus('Error processing audio', 'error');
        });

        socket.on('interview_error', (data) => {
            console.error('Interview error:', data);
            updateStatus(`Interview error: ${data.error}`, 'error');
            alert(`Interview error: ${data.error}`);
        });

        socket.on('interview_cancelled', (data) => {
            console.log('Interview cancelled');
            updateStatus('Interview cancelled', 'error');
        });

        socket.on('tts_error', (data) => {
            console.warn('Text-to-speech error:', data);
            // This is not critical, just log it
        });

        socket.on('error', (data) => {
            console.error('Socket error:', data);
            updateStatus(`Error: ${data.message}`, 'error');
            alert(`Error: ${data.message}`);
        });
    }

    document.getElementById('submit-text').addEventListener('click', function() {
        const answerText = document.getElementById('answer-text').value;
        const generateFollowUp = document.getElementById('generate-followup').checked;

        if (!answerText) {
            alert('Please enter an answer');
            return;
        }

        // Show loading state
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Submitting...';
        this.disabled = true;

        socket.emit('submit_answer', {
            session_id: sessionId,
            text: answerText,
            generateFollowUp: true
        });

        document.getElementById('answer-text').value = '';

        // Reset button after a short delay
        setTimeout(() => {
            this.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Submit Text Answer';
            this.disabled = false;
        }, 1000);
    });

    document.getElementById('record-audio').addEventListener('click', async function() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                
                // Convert to base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = function() {
                    const base64Audio = reader.result.split(',')[1];
                    const generateFollowUp = document.getElementById('generate-followup').checked;

                    console.log('Sending audio data, size:', base64Audio.length);

                    // Send the audio data to the server
                    socket.emit('submit_answer', {
                        session_id: sessionId,
                        audio: base64Audio,
                        generateFollowUp: generateFollowUp
                    });

                    updateStatus('Processing audio response...', 'waiting');

                    // Show transcription container
                    document.getElementById('transcription-container').style.display = 'block';
                    document.getElementById('transcription-text').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing your answer...';
                };

                reader.onerror = function(error) {
                    console.error('Error reading audio file:', error);
                    updateStatus('Error processing audio file', 'error');
                };

                // Stop all audio tracks
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
            };

            mediaRecorder.start();
            document.getElementById('record-audio').disabled = true;
            document.getElementById('stop-audio').disabled = false;

            // Show recording indicator
            document.querySelector('.recording-indicator').style.display = 'inline-block';
            updateStatus('Recording audio...', 'waiting');

        } catch (error) {
            updateStatus(`Error recording audio: ${error.message}`, 'error');
            alert(`Error recording audio: ${error.message}`);
        }
    });

    document.getElementById('stop-audio').addEventListener('click', function() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            document.getElementById('record-audio').disabled = false;
            document.getElementById('stop-audio').disabled = true;
            updateStatus('Processing audio response...', 'waiting');
        }
    });
</script>
</body>
</html>